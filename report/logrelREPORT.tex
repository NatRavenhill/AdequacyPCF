
Now that we have proved Correctness, we have proved half of Adequacy, as it is the following theorem:

\textcolor{red}{remove "and $\llbracket e \rrbracket = n$" from assumptions?"}

\vspace{0.5cm}

\begin{thm}
If $\vdash e : Nat$ (ie. $e$ is a closed term of type $Nat$) and $\llbracket e \rrbracket = n$ then $\llbracket e \rrbracket = n \Leftrightarrow e \mapsto^* \underline{n}$
\end{thm}

where $\llbracket e \rrbracket$ = $\llbracket \vdash e : Nat \rrbracket$ and $\underline{n}$ represents the numeral $n$, instead of the natural number $n$.

\section{$\Leftarrow$}
The right to left direction is a corollary of the correctness proof:

\vspace{0.5cm}

\begin{cor}
If $\vdash e : Nat$ and $\llbracket e \rrbracket = n$ then $e \mapsto^* \underline{n} \Rightarrow \llbracket e \rrbracket = n$
\end{cor}


\begin{proof}
Rewrite $e \mapsto^* \underline{n}$ as $e \mapsto e_0 \mapsto \dots \mapsto e_n \mapsto \underline{n}$ , for any $n \geq 0$. Applying correctness to these evaluations gives us $\llbracket e\rrbracket = \dots = \llbracket e_n \rrbracket = \llbracket \underline{n} \rrbracket$. Therefore we have $\llbracket  e \rrbracket = \llbracket \underline{n} \rrbracket$.

Now we need to prove $\forall n \in \mathbb{N}. \llbracket n \rrbracket = n$, which we prove by induction on $n$:

If $\underline{n} = zero$, then by the denotational semantics for $ zero$ we have $\llbracket e_n \rrbracket =  0$.

If $\underline{n} = s(v)$, then  in the rule, we have $\llbracket v \rrbracket$, which equals $v$ by the inductive hypothesis. Therefore, we use the case in the successor rule for a number and get $v + 1$.

Therefore $\forall n \in \mathbb{N}. \llbracket n \rrbracket  = n$, so $\llbracket e \rrbracket =  \llbracket n \rrbracket  = n$.

\end{proof} 

\section{$\Rightarrow$}

For the other direction, we want to show that if $\llbracket \cdot \vdash e : Nat \rrbracket = n$ then $e \mapsto^* n$. We cannot prove this by induction, so we need to define a \textbf{logical predicate} to use in the proof, inductively on types, which is the following:

\[Good_{Nat} = \{e  \ | \ \vdash e : Nat \ \wedge \ (\llbracket e \rrbracket = n \Rightarrow e \mapsto^* \underline{n}) \} \]

\[Good_{A \to B} = \{ e \ | \  \vdash e : A \to B \ \wedge \ \forall e' \in Good_A (e \ e') \in Good_B \}\]

Now to prove adequacy, we just prove that every well typed term is $Good$, so we also defined  $Good$ on typing contexts:

\[Good_{Ctx} (\cdot) = \{ <>\} \]
where $<>$ is the empty substitution and $\cdot$ is the empty context.

\[Good_{Ctx}(\Gamma, A) = \{ (\gamma, e/x) \ | \ \gamma \in Good_{Ctx}(\Gamma) \ \wedge \ e \in Good_A\} \]

For example, if we have the context $\Gamma = x_1 : A_1, \dots , x_n : A_n$ then:

\[Good_{Ctx} (x_1 : A_1, \dots ,x_n : A_n) = \{(e_1 / x_1, \dots, e_n / x_n) \ | \ e_i \in Good_{A_i}\} \]

From this we know that:

\begin{itemize}
\item{The set of free variables in the expression $[\gamma](e)$, $FV([\gamma](e)) = \emptyset$, because for any expression $e$, $FV(e) \subseteq \Gamma$ and $[\gamma]$ substitutes all the free variables in $\Gamma$ with expressions.}
\item{If $\gamma \in Good_{Ctx}(\Gamma)$ then $\gamma(x_i)$ has no free variables, because every expression in $\gamma$ that substitutes some $x_i$ is in $Good_{A_i}$, so is a closed term.}
\end{itemize}


Now we have this, we can prove the \textbf{Fundamental Lemma}, which is the following:

\vspace{0.5cm}

\begin{lem}
If $\Gamma \vdash e:A$ and $\gamma \in Good_{Ctx}(\Gamma)$, then $[\gamma](e) \in Good_A$
\end{lem}

\vspace{0.5cm}

\subsection{Substitution Function}
$[\gamma](e)$ is the expression obtained by applying a substitution $\gamma$ to an expression $e$. We can define it inductively in the following way:

\begin{adjustwidth}{2cm}{}
$[\gamma](zero) = zero$
\end{adjustwidth}

\begin{minipage}{3.5in}
\begin{align*}
[\gamma](x) = 
  \begin{cases} 
           [\gamma](x) & \text{if } x \in dom(\gamma) \\
           x & otherwise 
  \end{cases}
\end{align*} 
\end{minipage}

This says that if $x$ is present in $\gamma$, (there is a substitution for it), replace $x$ with the result of the substitution in $\gamma$. Otherwise there is nothing to replace $x$ with, so we return the variable unaltered. 

\vspace{0.5cm}

\begin{adjustwidth}{2cm}{}
$[\gamma](s(e)) = s([\gamma] (e))$

$[\gamma](case (e, z \mapsto e_0, s(v) \mapsto e_S)) = case ([\gamma](e), z \mapsto [\gamma](e_0), s(v) \mapsto [\gamma](e_S))$

$[\gamma](e \ e') = ([\gamma] e) ([\gamma] e')$

$[\gamma] (\lambda x:A. e) = \lambda x:A. [\gamma] e$

$[\gamma] (fix \ x:A. e) = fix \ x:A. [\gamma] e$
\end{adjustwidth}

\vspace{0.5cm}

For a non empty $\gamma = e_1/x_1, \dots e_n/x_n$, we have:

\[ [e_1/x_1, \dots , e_n/x_n] e = [e_1/x_1]([e_2/x_2]( \dots [e_n/x_n] e) \]

\section{Expansion Lemma}

To prove this lemma, we need another lemma for the $\lambda$-abstraction case. This lemma is called the \textbf{Expansion Lemma}:

\vspace{0.5cm}

\begin{lem}
If $ \vdash e : A$ and $e \mapsto e'$ and $e' \in Good_A$ then $e \in Good_A$
\end{lem}

\begin{proof}
By induction on types.

The base case will be when $\vdash e :  Nat$.  We have $e' \in Good_{Nat}$, so we have $\vdash e' : Nat$ and $\llbracket e' \rrbracket = n \Rightarrow e' \mapsto^* \underline{n}$. We need to show that $e \in Good_{Nat}$. We already have $\vdash e : Nat$ as it is one of our assumptions, so we just prove $\llbracket e \rrbracket = n \Rightarrow e \mapsto^* \underline{n}$.

Assume $\llbracket e \rrbracket = n$. Correctness in the empty context is $e \mapsto e' \Rightarrow \llbracket e \rrbracket = \llbracket e' \rrbracket$, so we use this to get $\llbracket e \rrbracket = \llbracket e' \rrbracket = n$. 

We can use $\llbracket e' \rrbracket = n$ to get $e' \mapsto^* \underline{n}$ from $e' \in Good_{Nat}$ . As $e \mapsto e'$ was an assumption, we now have $e \mapsto e' \ \wedge \ e' \mapsto^* \underline{n}$, so we have $e \mapsto^* \underline{n}$. Therefore $e \in Good_{Nat}$.

\vspace{0.5cm}

The inductive case will be when $\vdash e : A \to B$. We have $e \mapsto e'$ and $e' \in Good_{A \to B}$ and we need to show that $e \in Good_{A \to B}$. We already have $\vdash e : A \to B$, as it is one of our assumptions, so we just prove $\forall a \in Good_A. \ e \ a \in Good_B$.

Let $a : A$ be an expression such that $a \in Good_A$. Then we have $e' \ a \in Good_B$ from $e' \in Good_A$. We use $\vdash e : A \to B$ and $\vdash a : A$ (obtained from $a \in Good_A$) with the typing rule for function application to get $\vdash e \ a : B$. We use the congruence rule on $e \mapsto e'$ to get $e \ a \mapsto e' \ a$. 

Now we can apply the inductive hypothesis on $\vdash e \ a : B$, $e \ a \mapsto e' \ a$ and $e' \ a \in Good_B$ to get $e \ a \in Good_B$

Therefore $\forall a \in Good_A. e \ a \in Good_B$, so $e \in Good_{A \to B}$

Now we have proved all of the cases, so we know the lemma holds for expressions of any type $A$.

\end{proof}

\input{lemmasREPORT.tex}

\section{Main Lemma}
 
Now we can prove the Main Lemma:

\begin{proof}
By induction on $\Gamma \vdash e : A$

\paragraph{Variables} 
Given $\Gamma \vdash x : A$, from the typing rule we know that $\Gamma(x) = A$. Therefore we always have $x \in dom [\gamma]$.

As we have also assumed $\gamma \in Good_{Ctx}(\Gamma)$, we must have $e'/x$ in $\gamma$, where $e' \in Good_A$. 

By the definition of substitution on variables, if the variable we are substituting is not $x$, then we just return $x$, so $[ \delta, e'/x, \delta']x = [\delta, e'/x]x = [\delta]e'$. 

As $e' \in Good_A$, we know $e'$ is a closed term, so there are no free variables to substitute. Therefore $[\delta]e' = e'$, and $[\gamma]x \in Good_A$.  

%$[\gamma]x = [\gamma]x$, as $x \in dom[\gamma]$, so we will always have $[\gamma]x \in Good_A$.

%Given $\Gamma \vdash x : A$, from the typing rule we know that $\Gamma(x) = A$, and as the ordering of the pairs in $\Gamma$ does not matter, we can rewrite $\gamma \in Good_{Ctx}(\Gamma)$ as $\gamma \in Good_{Ctx}(\Gamma' ,A)$, where $\Gamma' = \Gamma/\{(x,A)\}$. Therefore, we know $x \in dom(\gamma)$, so we have $[\gamma](x) \in Good_A$.

\paragraph{Zero} $[\gamma](zero) = zero$, so we need to prove that $zero \in Good_{Nat}$. Therefore we first prove $\vdash zero : Nat$. As $zero$ is a constant, then we have it in any typing context, including the empty context. We must also prove $\llbracket zero \rrbracket = n \Rightarrow zero \mapsto^* \underline{n}$. 0 is the only possible value of $n$, as defined by the denotational semantics, so we need $zero \mapsto^* \underline{0}$. $zero$ is our representation of the numeral $\underline{0}$, so it maps to this in 0 steps. Therefore $zero \in Good_{Nat}$.

\paragraph{Successor}$[\gamma]s(e) = s([\gamma]e)$, so we must prove $s([\gamma]e) \in Good_{Nat}$. As we have a derivation of $\Gamma \vdash s(e) : Nat$, from the typing rule we also have $\Gamma \vdash e : Nat$. Therefore we can apply the inductive hypothesis to this and $\gamma \in Good_{Ctx}(\Gamma)$ to get $[\gamma]e \in Good_{Nat}$. Now there are two things we must show:

\begin{enumerate}
\item{$\vdash s([\gamma]e) : Nat$ \\
We have $\vdash [\gamma]e : Nat$ from $[\gamma]e \in Good_{Nat}$, so we use the typing rule on this to get $\vdash s([\gamma]e) : Nat$}
\item{\textbf{$\llbracket s([\gamma]e) \rrbracket = n \Rightarrow s([\gamma]e) \mapsto^* \underline{n}$} \\
Assume $\llbracket s([\gamma]e) \rrbracket = n$. By the definition of $\llbracket s([\gamma]e) \rrbracket$, we  must have $\llbracket [\gamma]e \rrbracket = n - 1$, because this is the only case that does not give $\bot$ as the final output. From $[\gamma]e \in Good_{Nat}$ and this we have $[\gamma]e \mapsto^* \underline{n - 1}$. Using the congruence rule for successor, with this as our assumption, we have $s([\gamma]e) \mapsto^* s(\underline{n -1})$, which is the same as the numeral $\underline{n}$. Therefore $s([\gamma]e) \mapsto^* \underline{n}$
}\end{enumerate}

Therefore $s([\gamma]e) \in Good_{Nat}$, so  by the definition of $[\gamma]$ we have $[\gamma]s(e)  \in Good_{Nat}$.

\paragraph{\textcolor{red}{Case}} $[\gamma](case (e, z \mapsto e_0, s(x) \mapsto e_S)) = case ([\gamma](e), z \mapsto [\gamma](e_0), s(x) \mapsto [\gamma](e_S)$ , so we need to prove that $case ([\gamma](e), z \mapsto [\gamma](e_0), s(x) \mapsto [\gamma](e_S)) \in Good_A$, for some type $A$. As we have a derivation of $\Gamma \vdash case (e, z \mapsto e_0, s(x) \mapsto e_S : A)$, from the typing rule we also have derivations for $\Gamma \vdash e : Nat$, $\Gamma \vdash e_0 : A$ and $\Gamma , x : Nat \vdash e_S : A$.

 Therefore we can apply the inductive hypothesis to this and $\gamma \in Good_{Ctx}(\Gamma)$ to get $[\gamma]e \in Good_{Nat}$ and $[\gamma]e_0 \in Good_A$. 
 
% \textcolor{red}{For $e_S$, we have $[\gamma']e_S \in Good_A$, where $\gamma' = (\gamma, e/v)$}.
 
Now we have three cases for the proof, depending on the value of $[\gamma]e$:

\begin{enumerate}
\item{When $[\gamma]e = zero$, the evaluation rule gives us $[\gamma]e_0$, so we must prove $[\gamma]e_0 \in Good_A$. We have the derivation tree for $\Gamma \vdash e_0 : A$, so we apply the inductive hypothesis with this and $\gamma \in Good_{Ctx}(\Gamma)$ to get $[\gamma]e_0 \in Good_A$}
\item{ \textcolor{red}{When $[\gamma]e = s(v)$, the evaluation rule gives us $[v/x]([\gamma]e_S)$, so we must prove $[v/x]([\gamma]e_S) \in Good_A$. We have the derivation tree for $\Gamma, x : Nat \vdash e_S : A$, so we apply the inductive hypothesis with this and $\gamma, v/x \in Good_{Ctx}(\Gamma, Nat)$ to get $[\gamma']e_S \in Good_A$}}
\item{When $e$ does not evaluate to a value, we need to show that for any expression $e$, its case statement is still in $Good_A$, so we will ultimately use \textbf{Lemma \ref{infinite}}.

By the definition of the denotational semantics, when we have $\llbracket [\gamma]e \rrbracket = \bot$, then $\llbracket case([\gamma]e, z \mapsto [\gamma]e_0, s(v) \mapsto [\gamma]e_S \rrbracket = \bot$.

We know that our case expression is a well typed closed term by \textbf{Lemma \ref{closedgamma}}, as we use our original assumption for $\Gamma \vdash case(e, z \mapsto e_0, s(v) \mapsto e_S)$ to get $\vdash [\gamma]case(e, z \mapsto e_0, s(v) \mapsto e_S)$.

Now we know it is a closed term,  we can use the \textbf{Lemma \ref{infinite}}, to get $case([\gamma]e, z \mapsto [\gamma]e_0, s(v) \mapsto [\gamma]e_S) \in Good_A$
}
\end{enumerate}

\paragraph{Application} $[\gamma](e_0 \ e_1) = ([\gamma] e_0) ([\gamma] e_1)$, so we need to prove that $([\gamma] e_0) ([\gamma] e_1) \in Good_B$. As we have a derivation of $\Gamma \vdash e_0 \ e_1 : B$, from the typing rule, we have derivations for $\Gamma \vdash e_0 : A \to B$ and $\Gamma \vdash e_1 : A$. Therefore we can apply the inductive hypothesis to these derivations and $\gamma \in Good_{Ctx}(\Gamma)$ to get $[\gamma]e_0 \in Good_{A \to B}$ and $[\gamma]e_1 \in Good_A$. 

From $[\gamma]e_0 \in Good_{A \to B}$, we know that $\forall e' \in Good_A. ([\gamma]e_0 \ e') \in Good_B$. As $[\gamma]e_1 \in Good_A$, then $([\gamma]e_0)([\gamma]e_1) \in Good_B$.

\paragraph{\textcolor{red}{$\lambda$-Abstraction}} $[\gamma] (\lambda x:A. \ e) = \lambda x:A. \ [\gamma] e$ so we must prove $\lambda x:A. \ [\gamma] e \in Good_{A \to B}$.  

There are two things we need to show:

\begin{enumerate}
\item{$\vdash \lambda x:A. \ [\gamma] e : A \to B$ \\ 
We can prove this using \textbf{Lemma \ref{closedgamma}}, as we have $\Gamma \vdash \lambda x : A . \ e : A \to B$. By using the lemma, we have $\vdash [\gamma]\lambda x : A . e : A = \ \vdash \lambda x : A . \ [\gamma] e : A \to B$}

\item{$\forall e' \in Good_A. \ (\lambda x:A. \ [\gamma]e) \ e' \in Good_B$ \\
Let $e':A$ be an expression such that $e' \in Good_A$. 

As we have a derivation of $\Gamma \vdash \lambda x:A. \ e : A \to B$, from the typing rule, we have $\Gamma, x:A \vdash e: B$. Let $\gamma' = (\gamma, e'/x)$, now we have $\gamma' \in Good_{Ctx}(\Gamma, A)$, so we use the induction hypothesis to get $[\gamma']e \in Good_B$.


Using the evaluation rule for $\lambda$ abstraction we have $(\lambda x:A. \ [\gamma]e) \ e' \mapsto [e'/x][\gamma]e$, \textcolor{red}{which can be simplified to $[\gamma, e'/x]e = [\gamma']e$.} We have $\vdash e' : A$ from $e' \in Good_A$ and $\vdash \lambda x:A. \ [\gamma] e : A \to B$ from the previous case, so we use the typing rule for function application to get $\vdash (\lambda x:A. \ [\gamma]e) \ e' : B$.

As $[\gamma']e \in Good_B$, we can use the Expansion Lemma to get $(\lambda x:A. \ [\gamma]e) \ e' \in Good_B$. Therefore we know $\forall e' \in Good_A. \ (\lambda x:A. \ [\gamma]e) \ e' \in Good_B$.}
\end{enumerate}

\paragraph{\textcolor{red}{Fixpoint}} $[\gamma] (fix \ x:A. e) = fix \ x:A. [\gamma] e$ so we must prove $fix \ x:A. [\gamma] e  \in Good_A$. As we have a derivation of $\Gamma \vdash fix \ x:A. \ e : A$, from the typing rule, we have $\Gamma, x:A \vdash e: A$. \textcolor{red}{Let $\gamma' = (\gamma, e'/x)$ for some expression $e' \in Good_{A}$ (so we have $\gamma' \in Good_{Ctx}(\Gamma, A))$.  Then using the induction hypothesis we have $[\gamma']e \in Good_A$. 
Let $e' = fix \ x:A \ e$. Then $[\gamma']e = [\gamma,fix \ x:A \ e/x] e = [\gamma][fix \ x:A \ e/x]e$.
Then as $[\gamma](fix \ x:A. e) \mapsto [\gamma]([fix \ x:A \ e/x]e)$ and $[\gamma]([fix \ x:A \ e/x]e) \in Good_A$, we use the Expansion Lemma with $\vdash fix \ x:A \ e : A$ to get  $[\gamma](fix \ x:A. e) \in Good_A$.}

\end{proof}
%todo FIX

We can now prove the second direction of Adequacy as a corollary of the Main Lemma:

\vspace{0.5cm}

\begin{cor}
If $\vdash e : Nat$ and $\llbracket e \rrbracket = n$ then $\llbracket e \rrbracket = n \Rightarrow e \mapsto^* \underline{n}$
\end{cor}

\begin{proof}
Using the Main Lemma, as we have $\vdash e : Nat$ and the empty substitution will be in $Good_{Ctx}(\cdot)$, we will have $[<>]e \in Good_{Nat}$. $[<>]e = e$, so we have $e \in Good_{Nat}$.

Expanding this definition gives us $\llbracket e \rrbracket = n \Rightarrow e \mapsto^* \underline{n}$, which is what we wanted to prove.
\end{proof}